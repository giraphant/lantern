# 资金费率套利策略

基于GRVT和Lighter之间的资金费率差异进行套利。

## 📖 策略说明

### 核心逻辑
1. 定期检查两个交易所的资金费率
2. 将不同周期的费率归一化为年化费率（APR）
3. 当年化费率差 > 阈值时建仓
4. 持仓期间持续积累费率收益
5. 当年化费率差 < 阈值或仓位达上限时平仓

### 盈利原理
- GRVT费率高时：做空GRVT（收费率）+ 做多Lighter（付费率）= 费率差收益
- Lighter费率高时：做多GRVT（付费率）+ 做空Lighter（收费率）= 费率差收益

### 归一化处理
不同交易所的资金费率周期不同，需要归一化为年化费率才能比较：

| 交易所 | 周期示例 | 原始费率 | 年化费率 |
|--------|---------|---------|---------|
| GRVT | 8小时 | 0.01% | 10.95% APR |
| Lighter | 1小时 | 0.005% | 43.8% APR |

**公式**: 年化费率 = 原始费率 × (24 / 周期小时数) × 365

---

## 🚀 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置环境变量

复制示例配置：
```bash
cp .env.funding.example .env
```

编辑 `.env` 文件：

```env
# API配置
GRVT_API_KEY=your_key
GRVT_PRIVATE_KEY=your_key
LIGHTER_PRIVATE_KEY=your_key

# 交易参数
TRADING_SYMBOL=BTC
TRADING_SIZE=0.1

# 资金费率配置
FUNDING_BUILD_THRESHOLD_APR=0.05    # 5% APR建仓
FUNDING_CLOSE_THRESHOLD_APR=0.02    # 2% APR平仓
MAX_POSITION=10
FUNDING_CHECK_INTERVAL=300          # 5分钟检查一次
```

### 3. 运行

```bash
python3 src/hedge_bot_funding.py
```

---

## 📊 配置参数详解

### FUNDING_BUILD_THRESHOLD_APR（建仓阈值）
- **含义**: 年化费率差大于此值时建仓
- **示例**: `0.05` = 5% APR
- **建议**:
  - 保守：5-10% APR
  - 激进：2-5% APR
  - 考虑交易成本后设定

### FUNDING_CLOSE_THRESHOLD_APR（平仓阈值）
- **含义**: 年化费率差小于此值时平仓
- **示例**: `0.02` = 2% APR
- **建议**:
  - 建议为BUILD阈值的40-50%
  - 避免频繁开平仓
  - 保持一定利润空间

### MAX_POSITION（最大仓位）
- **含义**: 单边最大持仓量
- **示例**: `10` = 10个币
- **建议**:
  - 根据账户资金量设定
  - 考虑流动性和滑点
  - 预留安全边际

### FUNDING_CHECK_INTERVAL（检查间隔）
- **含义**: 多久检查一次费率（秒）
- **示例**: `300` = 5分钟
- **建议**:
  - 费率变化较快：1-5分钟
  - 费率相对稳定：5-15分钟
  - 平衡API调用频率

---

## 💡 策略示例

### 示例1：正常套利流程

```
时间  | GRVT费率 | Lighter费率 | 年化差 | 仓位 | 操作
------|---------|------------|--------|-----|------
00:00 | 0.01%(8h)| 0.005%(1h) | 6.93% | 0   | BUILD LONG（差值>5%）
00:05 | 0.01%(8h)| 0.006%(1h) | 5.49% | 1   | BUILD LONG
00:10 | 0.01%(8h)| 0.007%(1h) | 4.05% | 2   | HOLD（差值在阈值之间）
00:15 | 0.008%(8h)| 0.007%(1h) | 1.82% | 2   | WINDDOWN（差值<2%）
00:20 | 0.007%(8h)| 0.007%(1h) | 0.73% | 1   | WINDDOWN
00:25 | 0.007%(8h)| 0.008%(1h) | -0.18%| 0   | 完成平仓
```

### 示例2：收益估算

**条件**：
- 年化费率差：5% APR
- 仓位：$10,000
- 持仓时间：7天

**收益计算**：
```
日化费率差 = 5% / 365 = 0.0137% 每天
7天收益 = $10,000 × 0.0137% × 7 = $9.59
```

---

## 🔒 风险控制

### 1. 费率反转风险
- **风险**: 费率差突然反转，造成亏损
- **应对**:
  - 设置合理的close阈值
  - 定期检查（5分钟）
  - 及时止损

### 2. 仓位风险
- **风险**: 持仓过大，面临爆仓风险
- **应对**:
  - 设置MAX_POSITION上限
  - 复用SafetyChecker安全检查
  - 保持足够保证金

### 3. 流动性风险
- **风险**: 平仓时滑点过大
- **应对**:
  - 选择流动性好的币种
  - 控制单次交易量
  - 使用Lighter市价单快速成交

### 4. API限流风险
- **风险**: 频繁查询触发API限制
- **应对**:
  - 调整check_interval
  - 使用合理的轮询频率
  - 缓存费率数据

---

## 📈 监控指标

运行时关注以下指标：

### 费率信息
```
💰 GRVT: 0.0100% (8h) → 10.95% APR | Lighter: 0.0050% (1h) → 43.80% APR | Spread: +32.85% APR (Daily: +0.0900%) | Strategy: SHORT
```

### 操作决策
```
📊 Action: BUILD | Spread 6.93% APR >= threshold 5.00%
```

### 收益估算
```
💵 Estimated daily profit: $9.59
```

---

## 🆚 与时间对冲策略对比

| 维度 | 时间对冲策略 | 资金费率套利策略 |
|------|-------------|----------------|
| **触发条件** | 基于时间周期 | 基于费率差 |
| **持仓时间** | 固定180秒 | 动态，费率差决定 |
| **收益来源** | 价差套利 | 费率差套利 |
| **频率** | 高频（每3分钟） | 低频（费率变化时） |
| **适用场景** | 短期价差 | 长期费率差 |
| **API压力** | 较高 | 较低 |

---

## 🐛 故障排查

### 问题1: 费率一直为0
**原因**: API返回数据格式不对或字段名错误
**解决**:
- 检查GRVT/Lighter API文档
- 验证 `get_funding_rate()` 实现
- 查看日志中的WARNING信息

### 问题2: 费率差计算异常
**原因**: 周期获取错误或归一化计算有误
**解决**:
- 检查 `get_funding_interval_hours()` 返回值
- 运行 `funding_rate_normalizer.py` 测试脚本
- 验证年化公式

### 问题3: 频繁开平仓
**原因**: BUILD和CLOSE阈值设置不合理
**解决**:
- 增大阈值差距（BUILD-CLOSE）
- 提高check_interval减少检查频率
- 观察费率波动范围后调整

---

## 📝 技术架构

```
src/
├── hedge/
│   ├── funding_rate_normalizer.py    # 费率归一化（纯函数）
│   ├── funding_rate_checker.py       # 套利机会检查（纯函数）
│   ├── safety_checker.py             # 安全检查（复用）
│   ├── rebalancer.py                 # 再平衡（复用）
│   └── trading_executor.py           # 交易执行（复用）
├── exchanges/
│   ├── base.py                       # 添加funding rate接口
│   ├── grvt.py                       # 实现funding rate
│   └── lighter.py                    # 实现funding rate
└── hedge_bot_funding.py              # 主程序
```

---

## 📄 许可

MIT License
